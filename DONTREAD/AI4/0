<!-- File: docs/proposals/capability-first-router-c1.md -->

### Capability-First Trigger Router (C1)

- **Goals**
  - Prioritize capabilities (e.g., foundation, interaction, security, data, QA, release) regardless of domain.
  - Guarantee correct rule attachments even with vague user prompts by centering on intended outcomes/outputs.
  - Reduce mis-routes in mixed stacks by separating "what" (capability) from "where" (domain/stack).

- **Assumptions**
  - Capability keywords are reliably present or inferable from context.
  - Domain and stack can be attached secondarily when needed.

- **Alternatives**
  - D1 Domain-First (existing).
  - H3 Hybrid Multi-Signal (see separate proposal).
  - GPE Graph Policy Engine (constraint solver).

- **Risks**
  - Pure capability routing may overlook domain nuances (e.g., mobile vs web a11y).
  - Over-attachment of overlays (noise).

- **Dependencies**
  - `1-master-rule-context-discovery.mdc` (scope/README loading).
  - `2-master-rule-ai-collaboration-guidelines.mdc`.
  - `F8-security-and-compliance-overlay.mdc` (global overlay).
  - Project rules `F1…F10` as needed by lifecycle.

### New Taxonomy (Capabilities)
- Foundation, Interaction, Brand/Premium, Data/ML, Architecture/Contracts, Security/Compliance, QA/Testing, Observability/Retro, Release/Deploy, Docs/Governance.

### Router Logic (C1)
- Step 1: Detect primary capability from message intent and required outputs.
- Step 2: Attach lifecycle overlays (e.g., `F6`, `F7`, `F10`, `F9`) based on verbs (implement/test/observe/release).
- Step 3: Attach domain and stack secondarily (web/mobile/backend/data/infra) for specificity.
- Step 4: Always apply Security overlay when risk keywords or sensitive data present.

### Trigger ↔ Rule(s) ↔ Files/Outputs
| Trigger (capability) | Rule(s) | Files/Outputs |
|---|---|---|
| foundation | `common-rule-ui-foundation-design-system`, `F3` | tokens JSON, grid/breakpoints, AA proofs, style guide |
| interaction | `common-rule-ui-interaction-a11y-perf`, `F3` | interaction spec JSON, a11y acceptance, perf checklist |
| brand/premium | `common-rule-ui-premium-brand-dataviz-enterprise-gated` | premium deltas, dataviz spec, enterprise pack |
| architecture/contracts | `F4`, `4-master-rule-code-modification-safety-protocol` | ADRs, OpenAPI vX.Y, contract tests/mocks |
| data/ml | `F5` | schema versions, lineage docs, quality thresholds |
| security/compliance | `F8` (project) + `F8 overlay (master)` | threat model, SBOM, scans, audit/evidence |
| qa/testing | `F7`, `3-master-rule-code-quality-checklist` | strategy doc, coverage thresholds, CI reports |
| observability/retro | `F10` | logs/metrics/traces plan, SLOs, dashboards, retro |
| release/deploy | `F9` | promotion pipeline, rollout/rollback plan, runbooks |
| docs/governance | `5-master-rule-documentation-and-context-guidelines`, `7-dev-workflow-command-router` | updated READMEs, checklists/templates |

### Backward-Compat: Old Trigger → New Capability Trigger(s)
| Old Trigger | New Trigger(s) | Affected Rules/Files |
|---|---|---|
| foundation, tokens, AA | capability:foundation | UI foundation rules, `F3` |
| interaction, a11y, LCP/INP/CLS | capability:interaction + perf | UI interaction rule, `F3` |
| premium, brand, dataviz, RBAC | capability:brand/premium + security | Premium rule, `F8` (if enterprise=true) |
| architecture, adr, contract | capability:architecture/contracts | `F4`, ADRs, OpenAPI |
| security, audit | capability:security/compliance | `F8` (project) + overlay |
| qa, test strategy | capability:qa/testing | `F7`, CI |
| observability, retro | capability:observability/retro | `F10` |
| release, deploy | capability:release/deploy | `F9` |
| prd, task generation, implement | lifecycle hooks (F1/F2/F6) | planning/implementation docs |

### Migration Plan
- Phase 1: Introduce capability detectors; log routing decisions alongside D1 for delta analysis.
- Phase 2: Capability-first primary; D1 as fallback when confidence < threshold.
- Phase 3: Decommission legacy capability heuristics; keep manual override.

### Example Messages → Resolution
- "Polish keyboard flows and focus states" → capability:interaction → `common-rule-ui-interaction-a11y-perf`, `F3`.
- "Add canary and rollback plan" → capability:release/deploy → `F9`, overlay security.
- "Define schema quality thresholds" → capability:data/ml → `F5`.

### Success Metrics
- Mis-route rate < 2%.
- First-try rule attachment ≥ 97%.
- Reduced time-to-first-output ≥ 20%.

### Next Steps
- Implement capability keyword/intent model.
- Confidence calibration with router telemetry.
- PR template update referencing capability sections.